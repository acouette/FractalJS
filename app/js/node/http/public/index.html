<html>
<body>

<div>
    <div>
        <div>
            <label>Clients per second: </label>
            <input onkeyup="onImagesPerSecondChange(this)" onmouseup="onImagesPerSecondChange(this)" type="number"
                   value="1"/>
        </div>


        <div>
            <label>Clients waiting : </label>
            <span id="client-waiting">N/A</span>


            <div>
                <label>Average wait time: </label>
                <span id="average-wait">N/A</span> ms
            </div>
            <div>
                <label>Average throughput: </label>
                <span id="average-throughput">N/A</span> images/second
            </div>
        </div>
    </div>
</div>

<div style="display: flex; flex-wrap: wrap">

    <div id="container"/>


</div>
<script>


    let imagesPerSecond = 1;
    let interval;


    let cumulatedLatencies = 0;
    let count = 0;
    let clientsWaiting = 0;


    function getFractal() {
        const randomCount = Math.round(Math.random() * 21);
        const randomDisableCache = Math.round(Math.random() * 100000);
        const img = document.createElement('img');
        img.style.cssText = "width: 100px; height: 100px; margin: 3px; display: none";
        document.getElementById("container").appendChild(img);
        clientsWaiting += 1;
        const start = new Date().getTime();

        fetch(`/random?preset=${randomCount}&width=100&height=100&random=${randomDisableCache}`, {
            method: "GET", // *GET, POST, PUT, DELETE, etc.
            mode: "cors", // no-cors, cors, *same-origin
            cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
            headers: {
                "Accept": "image/png",
            }
            //body: JSON.stringify(data), // body data type must match "Content-Type" header
        })
            .then(r => new Response(r.body))
            .then(response => response.blob())
            .then(blob => URL.createObjectURL(blob))
            .then(url => console.log(img.src = url))
            .then(() => {
                img.style.cssText = "width: 100px; height: 100px; margin: 3px";
                cumulatedLatencies += (new Date().getTime() - start);
                clientsWaiting -= 1;
                document.getElementById("client-waiting").textContent = clientsWaiting;
                count += 1;
            })
            .then(() => setTimeout(() => {
                img.remove();
            }, 3000))


            .catch(e => {
                console.error(e)
            });
    }

    function onImagesPerSecondChange(event) {
        imagesPerSecond = event.value;
        if (interval) {
            clearInterval(interval);
        }
        interval = setInterval(getFractal, (1 / imagesPerSecond) * 1000);
    }


    const statsHistory = [];
    const statPeriodInSeconds = 5;
    //stats
    setInterval(function () {
        const averageWait = Math.floor(cumulatedLatencies / count);
        const averageThroughput = count / statPeriodInSeconds;
        statsHistory.push({
            averageWait,
            averageThroughput,
        });

        document.getElementById("average-wait").textContent = averageWait.toString();
        document.getElementById("average-throughput").textContent = averageThroughput.toString();
        count = 0;
        cumulatedLatencies = 0;
    }, statPeriodInSeconds * 1000);


    onImagesPerSecondChange({
        value: 1
    });

</script>
</body>
</html>
