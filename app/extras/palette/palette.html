<html>
<body>
<script src="../../scripts/lib/jquery-2.1.3.min.js"></script>
<style>
body {
	background-color:black;
	color:#CCC;
	font-family:'arial',sans;
}
#droptarget.hover {
	border-color:red;
	color:white;
}
#droptarget {
	border:2px solid #CCC;
	padding:0.5em 1em;
	border-radius:8px;
}
.hidden {display:none}
h1 {margin-bottom:4px;}
.json {
	font-family:monospace
}
.bgrey {
	border:2px solid #AAA;
	padding:4px;
	float:left;
}
.palette {
	margin-bottom:0.5em;
}
</style>
<h1>Target Process Manager v3</h1><!-- work-neutral title to be changed -->
<p>Tested only with Chrome. Drag and drop an Apophysis UGR file anywhere on this page. Its palettes will be displayed with a string representation.</p>
<!--<div id="droptarget">Drop an UGR file here...</div>-->

<div class="model palette hidden">
<div class='bgrey'>
<canvas height="20"></canvas>
</div>
<span class="json">?</span>
</div>

<script>
$(function() {

	var pals = {}

	var tostr = function(r, g, b) {
		var tr = r.toString(16)
		var tg = g.toString(16)
		var tb = b.toString(16)
		if (tr.length==1) tr="0"+tr
		if (tg.length==1) tg="0"+tg
		if (tb.length==1) tb="0"+tb
		return tr+tg+tb
	}
	
	var displayPalette = function(pal) {
		var div = $(".model.palette").clone().removeClass("model hidden")
		var canvas = $("canvas", div)[0]
	
		canvas.width=pal.cols.length
		canvas.height=40
		$("body").append(div)
		var hstr = ""
		
		var ctx = canvas.getContext('2d');
		for(var i=0; i<pal.cols.length; i++) {
			var color = pal.cols[i]
			var b = color>>16 & 0xFF
			var g = color>>8 & 0xFF
			var r = color & 0xFF
			hstr += tostr(r, g, b)
			var txcol = "rgb("+r+","+g+","+b+")"
			ctx.strokeStyle = txcol;
			ctx.beginPath()
			ctx.moveTo(i+0.5,0);
			ctx.lineTo(i+0.5,canvas.height);
			ctx.stroke();
		}
		
		ctx.font = "14pt Calibri,Geneva,Arial";
		ctx.fillStyle = "white"
		ctx.strokeStyle = "black"
		ctx.strokeText(pal.title, 10, 30)
		ctx.fillText(pal.title, 10, 30)
		
		$(".json", div).text(hstr)
	}

	var apophysisImport = function(intext) {
		var lines = intext.match(/[^\r\n]+/g);
		var step = "NULL"
		var index = 0
		var pal
		
		for (var i in lines) {
			var line = lines[i]
			var match
			try {
				if (match = line.match(/^(.*) {$/)) {
					if (step!="NULL")
						throw "wrong step " + step
					step = "{"
					var title = match[1]
					index = 0
					pal = {title:title, cols:[]}
				}
				else if (match = line.match(/^gradient:$/)) {
					if (step!="{")
						throw "wrong step " + step
					step = "gradient"
				}
				else if (match = line.match(/^ title="(.*)" smooth=no$/)) {
					if (step!="gradient")
						throw "wrong step " + step
					var title = match[1]
					if (title!=pal.title)
						throw "different titles"
					step = "title"
				}
				else if (match = line.match(/^ index=(.*) color=(.*)$/)) {
					if (step!="title" && step!="index")
						throw "wrong step " + step
					var tindex = Number(match[1])
					var color = Number(match[2])
					var r = color>>16 & 0xFF
					var g = color>>8  & 0xFF
					var b = color	  & 0xFF
					pal.cols.push(r<<16 | g<<8 | b)
					index++
					step = "index"
				}
				else if (match = line.match(/^[ ]*$/)) {
					// pass
				}
				else if (match = line.match(/^}$/)) {
					if (step!="index")
						throw "wrong step " + step
					step = "NULL"
					pals[pal.title] = pal
				}
				else {
					throw "unknown line [" + line + "]"
				}
			} catch (e) {
				console.log("ERROR", e)
				console.log(line)
				console.log(step, title, index)
				throw e
			}
		}
		//console.log(paltostr(pals[1]))
		for (var paln in pals)
			displayPalette(pals[paln])
		console.log("OK")
	}

	$("#droptarget, body").on("dragover dragleave drop", function(e) {
		e.stopPropagation();
		e.preventDefault();
		if (e.type == "drop") {
			var files = e.originalEvent.dataTransfer.files;
			var file = files[0] // take only the first file in case of a list
			var reader = new FileReader();
			reader.onload = function(e) {
				apophysisImport(e.target.result);
			};
			reader.readAsText(file);
		}
	})
	
})
</script>

</body>
</html>